<?xml version="1.0" encoding="UTF-8" ?>
 <Module specificationVersion='2'>
   <ModulePrefs title="The Lando's App!" height="550">
     <Require feature="osapi"/>
     <Require feature="embedded-experiences"/>
     <Optional feature="content-rewrite">
       <Param name="exclude-url">*</Param> 
     </Optional>
     
   </ModulePrefs>
   <Content type="html" view="default">
     <![CDATA[
      <script>
        var hasContext = false;
      </script>
      ]]>
   </Content>
   <Content type="html" view="embedded">
     <![CDATA[
      <script>
        var hasContext = true;
      </script>
      ]]>
   </Content>

   <Content type="html" view="default,embedded">
    <![CDATA[
    <script src="js/libs/hogan.js"></script>
    <script>
      var gUserId = "";
      var gRunId = "";
      var require = {
        config: {
          text: {
            env: "gadget",
            useXhr: function (url, protocol, hostname, port) {
              return true;
            }
          }
        },
        baseUrl: "http://kargath.notesdev.ibm.com:8080/js/",
        paths: {
          "jquery": 'libs/jquery',
          "underscore": 'libs/underscore',
          "backbone": 'libs/backbone',
          "hogan": 'libs/hogan',
          "io": 'libs/io',
          "collapse": "libs/bootstrap-collapse",
          "templates" : "http://kargath.notesdev.ibm.com:8080/templates"
        }
    };
    </script>
    
    <link type="text/css" href="css/bootstrap.css" rel="stylesheet">
    <link type="text/css" href="css/docs.css" rel="stylesheet">
    <link type="text/css" href="css/bootstrap-responsive.css" rel="stylesheet">
    <style>
    .success
    {
      color:green;
    }
    .error
    {
      color:red;
    }
    </style>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a id="home_btn" class="brand" href="#main_nav"> The Lando's App!</a>
          <div class="nav-collapse collapse">
            <ul id="main-nav-list" class="nav">
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>    
    
    <div id="canvas" class="container">
    </div>

    <script>
      // Set UserId
      gadgets.util.registerOnLoadHandler(function() {
        var batch = osapi.newBatch();
        batch.add('viewer', osapi.people.getViewer());
        batch.add('owner', osapi.people.getOwner());
        batch.execute(function(response) {
          // format the username so that we can use it
          var l = response.viewer.id.split(":");
          if (l.length > 1) {
            l.reverse();
            gUserId = l[0].concat("@" + l[1]);
          } else {
            gUserId = response.viewer.id;
          }
        });
      });

      var injectRequireJs = function() {
        var head = document.getElementsByTagName('head').item(0);
        var script = document.createElement("script");
        script.setAttribute("data-main", "main");
        script.src = require.baseUrl + "libs/require.js";
        head.appendChild(script);
      };

      if (hasContext) {
        // Set the RunId
        gadgets.util.registerOnLoadHandler(function() {
          opensocial.data.getDataContext().registerListener('org.opensocial.ee.context', function(key) {
          var _runId = opensocial.data.getDataContext().getDataSet(key);
          var setRunId = function(data) {
            if (data && data.data && data.data.run_id === _runId) {
                gRunId = _runId;
            }
            injectRequireJs();
          };
          var params = {};
          params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
          params[gadgets.io.RequestParameters.METHOD] = "GET";
          params[gadgets.io.RequestParameters.REFRESH_INTERVAL] = 0;

          gadgets.io.makeRequest("http://kargath.notesdev.ibm.com:8080/run/current", setRunId, params)
          });
        });
      } else {
        injectRequireJs();
      }
    </script>
  ]]>
   </Content>
 </Module>
